"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[42],{2042:function(e,r,t){t.d(r,{E:function(){return i},V:function(){return l}});var o=t(7437),a=t(2265),c=t(3325),n=t(2136);let s=(0,a.createContext)(void 0),l=e=>{let{children:r}=e,[t,l]=(0,a.useState)([]),[i,d]=(0,a.useState)([]),[u,h]=(0,a.useState)([]),[g,p]=(0,a.useState)(!0),[D,f]=(0,a.useState)(null),[y,S]=(0,a.useState)(0),v=async function(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];try{if(console.log("\uD83D\uDE80 OptimizedUserDataContext: Starting progressive loading..."),!e&&n.d.hasValidCache()){let e=n.d.getAllUserData();if(e){console.log("✅ Using cached user data (expires in",n.d.getTimeUntilExpiry(),"seconds)"),l(e.products||[]),d(e.madeToOrderProducts||[]),h(e.wilayaTariffs||[]),f(new Date),S(n.d.getTimeUntilExpiry()),p(!1),console.log("\uD83D\uDD04 Updating cache in background..."),k().catch(e=>{console.error("❌ Background cache update failed:",e)});return}}console.log("\uD83C\uDD95 No valid cache, starting progressive loading..."),p(!0),await k()}catch(e){console.error("❌ OptimizedUserDataContext: Error loading user data:",e),p(!1)}},k=async()=>{try{console.log("\uD83C\uDF10 Starting progressive data loading..."),console.log("\uD83D\uDCE6 Step 1: Loading products...");let e=await fetch("/api/products"),r=await e.json(),t=r.success?r.data:[];console.log("✅ Products loaded:",t.length),l(t),f(new Date),S(300),p(!1),n.d.setAllUserData({products:t,madeToOrderProducts:[],wilayaTariffs:[]});try{console.log("\uD83C\uDFA8 Step 2: Loading made-to-order products...");let e=await fetch("/api/made-to-order"),r=await e.json(),o=Array.isArray(r)?r:[];console.log("✅ Made-to-order products loaded:",o.length),d(o),n.d.setAllUserData({products:t,madeToOrderProducts:o,wilayaTariffs:[]})}catch(e){console.error("❌ Made-to-order loading failed:",e)}setTimeout(async()=>{try{console.log("\uD83D\uDDFA️ Step 3: Loading wilaya data...");let e=await c.k.getWilayaTariffs();console.log("✅ Wilaya data loaded:",e.length),h(e),n.d.setAllUserData({products:t,madeToOrderProducts:[],wilayaTariffs:e})}catch(e){console.error("❌ Wilaya loading failed:",e)}},100)}catch(e){console.error("❌ Error in progressive loading:",e),p(!1)}},w=async()=>{console.log("\uD83D\uDD04 OptimizedUserDataContext: Force refreshing all data..."),await v(!0)};return(0,a.useEffect)(()=>{v();let e=setInterval(()=>{console.log("⏰ OptimizedUserDataContext: Auto-refreshing all data..."),v(!0)},6e4),r=setInterval(()=>{S(n.d.getTimeUntilExpiry())},1e3);return()=>{clearInterval(e),clearInterval(r)}},[]),(0,o.jsx)(s.Provider,{value:{products:t,madeToOrderProducts:i,wilayaTariffs:u,loading:g,lastUpdated:D,timeUntilRefresh:y,refreshAllData:w,getProduct:e=>t.find(r=>r.id===e),getMadeToOrderProduct:e=>i.find(r=>r.id===e)},children:r})},i=()=>{let e=(0,a.useContext)(s);if(void 0===e)throw Error("useOptimizedUserData must be used within an OptimizedUserDataProvider");return e}},2136:function(e,r,t){t.d(r,{d:function(){return c}});let o="user_products_cache",a="user_all_data_cache",c={getProducts(){try{let e=localStorage.getItem(o);if(!e)return null;let r=JSON.parse(e),t=Date.now();if(t>r.expiresAt)return console.log("\uD83D\uDD50 User cache expired, clearing..."),this.clearCache(),null;return console.log("✅ Using cached user data (expires in",Math.round((r.expiresAt-t)/1e3),"seconds)"),console.log("\uD83D\uDCCA Cache contains",r.products.length,"products"),r.products}catch(e){return console.error("❌ Error reading user cache:",e),this.clearCache(),null}},setProducts(e){try{let r=Date.now();localStorage.setItem(o,JSON.stringify({products:e,timestamp:r,expiresAt:r+3e5})),console.log("\uD83D\uDCBE User data cached for 1 minute (",e.length,"products)")}catch(e){console.error("❌ Error setting user cache:",e)}},clearCache(){try{localStorage.removeItem(o),console.log("\uD83D\uDDD1️ User cache cleared")}catch(e){console.error("❌ Error clearing user cache:",e)}},hasValidCache(){try{let e=localStorage.getItem(o);if(!e)return!1;let r=JSON.parse(e);return Date.now()<=r.expiresAt}catch(e){return!1}},getTimeUntilExpiry(){try{let e=localStorage.getItem(o);if(!e)return 0;let r=JSON.parse(e),t=Math.max(0,r.expiresAt-Date.now());return Math.round(t/1e3)}catch(e){return 0}},getAllUserData(){try{let e=localStorage.getItem(a);if(!e)return null;let r=JSON.parse(e),t=Date.now();if(t>r.expiresAt)return console.log("\uD83D\uDD50 All user data cache expired, clearing..."),this.clearAllUserDataCache(),null;return console.log("✅ Using cached all user data (expires in",Math.round((r.expiresAt-t)/1e3),"seconds)"),console.log("\uD83D\uDCCA Cache contains",r.products.length,"products,",r.madeToOrderProducts.length,"made-to-order products,",r.wilayaTariffs.length,"wilayas"),r}catch(e){return console.error("❌ Error reading all user data cache:",e),this.clearAllUserDataCache(),null}},setAllUserData(e){try{let r=Date.now(),t={products:e.products,madeToOrderProducts:e.madeToOrderProducts,wilayaTariffs:e.wilayaTariffs,timestamp:r,expiresAt:r+3e5},o=JSON.stringify(t),c=new Blob([o]).size;if(console.log("\uD83D\uDCCA Cache data size: ".concat(Math.round(c/1024),"KB (").concat(e.products.length," products, ").concat(e.madeToOrderProducts.length," made-to-order products, ").concat(e.wilayaTariffs.length," wilayas)")),c>4194304){console.warn("⚠️ Data too large for localStorage, using individual caches instead"),this.setProducts(e.products);return}localStorage.setItem(a,o),console.log("\uD83D\uDCBE All user data cached for 1 minute")}catch(r){r instanceof DOMException&&"QuotaExceededError"===r.name?(console.warn("⚠️ localStorage quota exceeded, falling back to individual caches"),this.setProducts(e.products)):console.error("❌ Error setting all user data cache:",r)}},clearAllUserDataCache(){try{localStorage.removeItem(a),console.log("\uD83D\uDDD1️ All user data cache cleared")}catch(e){console.error("❌ Error clearing all user data cache:",e)}}}},3325:function(e,r,t){t.d(r,{k:function(){return c}});var o=t(2601);class a{getApiUrl(e){return"".concat(this.baseUrl).concat(e)}isBrowser(){return"undefined"!=typeof fetch}getAuthHeaders(){let e=o.env.NEXT_PUBLIC_API_AUTH_TOKEN||"obsidian-api-token-2025";return console.log("\uD83D\uDD27 BackendService: Using auth token:",e),{Authorization:"Bearer ".concat(e),"Content-Type":"application/json"}}async getProducts(){try{let e=await fetch(this.getApiUrl("/products"),{method:"GET",headers:{"Content-Type":"application/json","Cache-Control":"max-age=30"},next:{revalidate:30}});if(!e.ok)throw Error("HTTP error! status: ".concat(e.status));let r=await e.json();if(r.success)return console.log("BackendService: Fetched",r.count,"products"),r.data||[];return console.error("BackendService: Failed to fetch products:",r.error),[]}catch(e){return console.error("BackendService: Error fetching products:",e),[]}}async getProduct(e){try{let r=await fetch(this.getApiUrl("/products/".concat(e))),t=await r.json();if(t.success)return console.log("BackendService: Fetched product:",e),t.data;return console.error("BackendService: Failed to fetch product:",t.error),null}catch(e){return console.error("BackendService: Error fetching product:",e),null}}async addProduct(e){try{console.log("\uD83D\uDD27 BackendService: addProduct called with:",e),console.log("\uD83D\uDD27 BackendService: Product price type:",typeof e.price,"Value:",e.price),console.log("\uD83D\uDD27 BackendService: JSON stringified product:",JSON.stringify(e,null,2)),console.log("\uD83D\uDD27 BackendService: API URL:",this.getApiUrl("/products")),console.log("\uD83D\uDD27 BackendService: Auth headers:",this.getAuthHeaders());let r=await fetch(this.getApiUrl("/products"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});console.log("\uD83D\uDD27 BackendService: Response status:",r.status),console.log("\uD83D\uDD27 BackendService: Response ok:",r.ok);let t=await r.json();if(console.log("\uD83D\uDD27 BackendService: Response data:",t),t.success)return console.log("✅ BackendService: Created product:",t.data.id),t.data;return console.error("❌ BackendService: Failed to create product:",t.error),null}catch(e){return console.error("❌ BackendService: Error creating product:",e),null}}async updateProduct(e,r){try{let t=await fetch(this.getApiUrl("/products/".concat(e)),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)}),o=await t.json();if(o.success)return console.log("BackendService: Updated product:",e),o.data;return console.error("BackendService: Failed to update product:",o.error),null}catch(e){return console.error("BackendService: Error updating product:",e),null}}async deleteProduct(e){try{console.log("\uD83D\uDD27 BackendService: Deleting product:",e),console.log("\uD83D\uDD27 BackendService: API URL:",this.getApiUrl("/products/".concat(e))),console.log("\uD83D\uDD27 BackendService: Auth headers:",this.getAuthHeaders());let r=await fetch(this.getApiUrl("/products/".concat(e)),{method:"DELETE",headers:{"Content-Type":"application/json"}});if(console.log("\uD83D\uDD27 BackendService: Response status:",r.status),console.log("\uD83D\uDD27 BackendService: Response headers:",Object.fromEntries(r.headers.entries())),!r.ok){console.error("❌ BackendService: HTTP error! status:",r.status);let e=await r.text();return console.error("❌ BackendService: Error response body:",e),!1}let t=await r.json();if(console.log("\uD83D\uDD27 BackendService: Response JSON:",t),t.success)return console.log("✅ BackendService: Deleted product:",e),!0;return console.error("❌ BackendService: Failed to delete product:",t.error),!1}catch(e){return console.error("❌ BackendService: Error deleting product:",e),!1}}async getOrders(){try{let e=await fetch(this.getApiUrl("/orders"),{method:"GET",headers:this.getAuthHeaders(),next:{revalidate:30}});if(!e.ok)throw Error("HTTP error! status: ".concat(e.status));let r=e.headers.get("content-type");if(!r||!r.includes("application/json")){let t=await e.text();return console.error("BackendService: Received non-JSON response:",{status:e.status,contentType:r,text:t.substring(0,200)}),[]}let t=await e.json();if(t.success)return console.log("BackendService: Fetched",t.count,"orders"),t.data||[];return console.error("BackendService: Failed to fetch orders:",t.error),[]}catch(e){return console.error("BackendService: Error fetching orders:",e),[]}}async getOrder(e){try{let r=await fetch(this.getApiUrl("/orders/".concat(e)),{headers:this.getAuthHeaders()}),t=await r.json();if(t.success)return console.log("BackendService: Fetched order:",e),t.data;return console.error("BackendService: Failed to fetch order:",t.error),null}catch(e){return console.error("BackendService: Error fetching order:",e),null}}async addOrder(e){try{let r=await fetch(this.getApiUrl("/orders"),{method:"POST",headers:this.getAuthHeaders(),body:JSON.stringify(e)}),t=await r.json();if(t.success)return console.log("BackendService: Created order:",t.data.id),t.data;return console.error("BackendService: Failed to create order:",t.error),null}catch(e){return console.error("BackendService: Error creating order:",e),null}}async updateOrder(e,r){try{let t=await fetch(this.getApiUrl("/orders/".concat(e)),{method:"PUT",headers:this.getAuthHeaders(),body:JSON.stringify(r)}),o=await t.json();if(o.success)return console.log("BackendService: Updated order:",e),o.data;return console.error("BackendService: Failed to update order:",o.error),null}catch(e){return console.error("BackendService: Error updating order:",e),null}}async deleteOrder(e){try{let r=await fetch(this.getApiUrl("/orders/".concat(e)),{method:"DELETE",headers:this.getAuthHeaders()}),t=await r.json();if(t.success)return console.log("BackendService: Deleted order:",e),!0;return console.error("BackendService: Failed to delete order:",t.error),!1}catch(e){return console.error("BackendService: Error deleting order:",e),!1}}async getCustomers(){try{let e=await fetch(this.getApiUrl("/customers")),r=await e.json();if(r.success)return console.log("BackendService: Fetched",r.count,"customers"),r.data||[];return console.error("BackendService: Failed to fetch customers:",r.error),[]}catch(e){return console.error("BackendService: Error fetching customers:",e),[]}}async addCustomer(e){try{let r=await fetch(this.getApiUrl("/customers"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),t=await r.json();if(t.success)return console.log("BackendService: Created customer:",t.data.id),t.data;return console.error("BackendService: Failed to create customer:",t.error),null}catch(e){return console.error("BackendService: Error creating customer:",e),null}}async getWilayaTariffs(){try{let e=await fetch(this.getApiUrl("/wilaya")),r=await e.json();if(r.success)return console.log("BackendService: Fetched",r.count,"wilaya tariffs"),r.data||[];return console.error("BackendService: Failed to fetch wilaya tariffs:",r.error),[]}catch(e){return console.error("BackendService: Error fetching wilaya tariffs:",e),[]}}async updateWilayaTariffs(e){try{let r=await fetch(this.getApiUrl("/wilaya"),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),t=await r.json();if(t.success)return console.log("BackendService: Updated wilaya tariffs"),!0;return console.error("BackendService: Failed to update wilaya tariffs:",t.error),!1}catch(e){return console.error("BackendService: Error updating wilaya tariffs:",e),!1}}constructor(){this.baseUrl="/api"}}let c=new a}}]);