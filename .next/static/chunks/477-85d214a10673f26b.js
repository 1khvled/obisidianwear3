"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[477],{5501:function(e,t,n){n.r(t),n.d(t,{AuthProvider:function(){return l},useAuth:function(){return u}});var a=n(7437),i=n(2265),r=n(2671);class s{static getInstance(){return s.instance||(s.instance=new s),s.instance}generateSessionId(){{let e=sessionStorage.getItem("obsidian-admin-session-id");return e||(e="admin_"+Date.now()+"_"+Math.random().toString(36).substr(2,9),sessionStorage.setItem("obsidian-admin-session-id",e)),e}}async createSession(e){try{if(!r.OQ)return console.error("Supabase client not initialized"),!1;let t=new Date(Date.now()+this.SESSION_DURATION).toISOString(),{error:n}=await r.OQ.from("admin_sessions").upsert({session_id:this.sessionId,username:e,is_active:!0,expires_at:t});if(n)return console.error("Error creating session:",n),!1;return"undefined"!=typeof document&&(document.cookie="obsidian-admin-session-id=".concat(this.sessionId,"; path=/; max-age=").concat(this.SESSION_DURATION/1e3,"; secure; samesite=strict")),!0}catch(e){return console.error("Error creating session:",e),!1}}async getSession(){try{if(!r.OQ)return console.error("Supabase client not initialized"),null;if(!this.sessionId)return console.error("No session ID available"),null;let{data:e,error:t}=await r.OQ.from("admin_sessions").select("*").eq("session_id",this.sessionId).eq("is_active",!0).single();if(t&&"PGRST116"!==t.code)return console.error("Error fetching session:",t),null;if(!e)return null;let n=new Date,a=new Date(e.expires_at);if(n>a)return await this.deactivateSession(),null;return e}catch(e){return console.error("Error fetching session:",e),null}}async deactivateSession(){try{if(!r.OQ)return console.error("Supabase client not initialized"),!1;let{error:e}=await r.OQ.from("admin_sessions").update({is_active:!1}).eq("session_id",this.sessionId);if(e)return console.error("Error deactivating session:",e),!1;return"undefined"!=typeof document&&(document.cookie="obsidian-admin-session-id=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT"),!0}catch(e){return console.error("Error deactivating session:",e),!1}}async isAuthenticated(){return null!==await this.getSession()}async getUsername(){let e=await this.getSession();return(null==e?void 0:e.username)||null}async cleanupExpiredSessions(){try{if(!r.OQ){console.error("Supabase client not initialized");return}let e=new Date().toISOString();await r.OQ.from("admin_sessions").update({is_active:!1}).lt("expires_at",e)}catch(e){console.error("Error cleaning up expired sessions:",e)}}constructor(){this.SESSION_DURATION=864e5,this.sessionId=this.generateSessionId()}}var o=s.getInstance();let c=(0,i.createContext)(void 0),l=e=>{let{children:t}=e,[n,r]=(0,i.useState)(!1),[s,l]=(0,i.useState)(""),[u,d]=(0,i.useState)(!0);(0,i.useEffect)(()=>{(async()=>{try{if(d(!0),await o.isAuthenticated()){let e=await o.getUsername();r(!0),l(e||"")}else r(!1),l("")}catch(e){console.error("Error checking authentication:",e),r(!1),l("");try{await o.deactivateSession()}catch(e){console.error("Error clearing invalid session:",e)}}finally{d(!1)}})();let e=setInterval(async()=>{if(n)try{await o.isAuthenticated()||(r(!1),l(""))}catch(e){console.error("Session validation error:",e),r(!1),l("")}},6e4);return()=>clearInterval(e)},[n]);let h=async(e,t)=>{try{let n=await fetch("/api/auth/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:e,password:t})});if(n.ok&&(await n.json()).success&&await o.createSession(e))return r(!0),l(e),!0}catch(e){console.error("Error during login:",e)}return!1},m=async()=>{try{await o.deactivateSession(),r(!1),l("")}catch(e){console.error("Error logging out:",e)}};return(0,a.jsx)(c.Provider,{value:{isAuthenticated:n,login:h,logout:m,username:s,loading:u},children:t})},u=()=>{let e=(0,i.useContext)(c);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e}},6713:function(e,t,n){n.r(t),n.d(t,{ThemeProvider:function(){return s},useTheme:function(){return o}});var a=n(7437),i=n(2265);let r=(0,i.createContext)(void 0);function s(e){let{children:t}=e,[s,o]=(0,i.useState)("dark");return(0,i.useEffect)(()=>{(async()=>{try{let e=(await n.e(755).then(n.bind(n,9755))).default,t=await e.getTheme();if(t&&("light"===t||"dark"===t))o(t);else{let t=localStorage.getItem("admin-theme");t&&("light"===t||"dark"===t)&&(o(t),await e.setTheme(t))}}catch(t){console.error("Error loading theme:",t);let e=localStorage.getItem("admin-theme");e&&("light"===e||"dark"===e)&&o(e)}})()},[]),(0,i.useEffect)(()=>{if(localStorage.setItem("admin-theme",s),(async()=>{try{let e=(await n.e(755).then(n.bind(n,9755))).default;await e.setTheme(s)}catch(e){console.error("Error saving theme to database:",e)}})(),"undefined"!=typeof document){document.documentElement.setAttribute("data-theme",s);let e=document.querySelector('meta[name="theme-color"]');e&&e.setAttribute("content","dark"===s?"#000000":"#ffffff")}},[s]),(0,a.jsx)(r.Provider,{value:{theme:s,toggleTheme:()=>{o(e=>"dark"===e?"light":"dark")},setTheme:e=>{o(e)}},children:t})}function o(){let e=(0,i.useContext)(r);if(void 0===e)throw Error("useTheme must be used within a ThemeProvider");return e}},7508:function(e,t,n){n.d(t,{q:function(){return o}});var a=n(2265),i=n(2671);class r{async getMaintenanceStatus(){let e=Date.now();if(this.cache&&e-this.lastFetch<this.cacheTimeout)return this.cache;try{if(!i.OQ)return console.error("Supabase client not initialized"),{is_maintenance:!1,drop_date:null};let{data:t,error:n}=await i.OQ.from("maintenance_status").select("*").eq("id","maintenance").single();if(n)throw n;let a=t||{id:"maintenance",is_maintenance:!1,drop_date:new Date(Date.now()+2592e6).toISOString(),updated_at:new Date().toISOString()};return this.cache=a,this.lastFetch=e,a}catch(e){return console.error("Failed to fetch maintenance status:",e),this.cache||{id:"maintenance",is_maintenance:!1,drop_date:new Date(Date.now()+2592e6).toISOString(),updated_at:new Date().toISOString()}}}async setMaintenanceStatus(e){try{var t;let n="offline"===e,a={id:"maintenance",is_maintenance:n,drop_date:(null===(t=this.cache)||void 0===t?void 0:t.drop_date)||new Date(Date.now()+2592e6).toISOString(),updated_at:new Date().toISOString()};return this.cache=a,this.lastFetch=Date.now(),setTimeout(async()=>{try{if(!i.OQ){console.error("Supabase client not initialized");return}let{error:e}=await i.OQ.from("maintenance_status").update({is_maintenance:n,updated_at:new Date().toISOString()}).eq("id","maintenance");e?console.error("Maintenance status update error:",e):console.log("Maintenance status updated successfully")}catch(e){console.error("Background maintenance update failed:",e)}},0),!0}catch(e){return console.error("Failed to set maintenance status:",e),!1}}async toggleMaintenanceStatus(){let e=(await this.getMaintenanceStatus()).is_maintenance?"online":"offline";return await this.setMaintenanceStatus(e)}async getMaintenanceAnalytics(){try{if(!i.OQ)return console.error("Supabase client not initialized"),null;let{data:e,error:t}=await i.OQ.rpc("get_maintenance_analytics");if(t)throw t;return(null==e?void 0:e[0])||null}catch(e){return console.error("Failed to get maintenance analytics:",e),null}}clearCache(){this.cache=null,this.lastFetch=0}getCachedStatus(){let e=Date.now();return this.cache&&e-this.lastFetch<this.cacheTimeout?this.cache:null}constructor(){this.cache=null,this.cacheTimeout=5e3,this.lastFetch=0}}let s=new r;function o(){let[e,t]=(0,a.useState)({id:"maintenance",is_maintenance:!1,drop_date:new Date(Date.now()+2592e6).toISOString(),updated_at:new Date().toISOString()}),[n,i]=(0,a.useState)(!0),[r,o]=(0,a.useState)(null),[c,l]=(0,a.useState)(null),u=(0,a.useCallback)(async()=>{try{i(!0),o(null);let[e,n]=await Promise.all([s.getMaintenanceStatus(),s.getMaintenanceAnalytics()]);t(e),l(n)}catch(e){o(e instanceof Error?e.message:"Failed to load maintenance status")}finally{i(!1)}},[]),d=(0,a.useCallback)(async()=>{await u()},[u]),h=(0,a.useCallback)(async e=>{try{if(t(t=>({...t,status:e,updated_at:new Date().toISOString()})),!await s.setMaintenanceStatus(e))return await u(),!1;return!0}catch(e){return console.error("Failed to set maintenance status:",e),await u(),!1}},[u]),m=(0,a.useCallback)(async()=>{let t=e.is_maintenance?"online":"offline";return await h(t)},[e.is_maintenance,h]);return(0,a.useEffect)(()=>{u()},[u]),(0,a.useEffect)(()=>{let e=setInterval(()=>{n||u()},1e4);return()=>clearInterval(e)},[u,n]),{status:e,loading:n,error:r,toggleStatus:m,setStatus:h,refreshStatus:d,analytics:c}}}}]);